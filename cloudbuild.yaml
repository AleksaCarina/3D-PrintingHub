steps:
  # Build the image from the Dockerfile at repo root
  - name: gcr.io/cloud-builders/docker
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/printinghub:$SHORT_SHA', '.']

  # Push the image
  - name: gcr.io/cloud-builders/docker
    args: ['push', 'gcr.io/$PROJECT_ID/printinghub:$SHORT_SHA']

  # Deploy to Cloud Run
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk:slim
    entrypoint: gcloud
    args:
      [
        'run','deploy','$_SERVICE',
        '--image','gcr.io/$PROJECT_ID/printinghub:$SHORT_SHA',
        '--region','$_REGION',
        '--platform','managed',
        '--allow-unauthenticated'
      ]

images:
  - 'gcr.io/$PROJECT_ID/printinghub:$SHORT_SHA'

options:
  logging: CLOUD_LOGGING_ONLY

substitutions:
  _SERVICE: 'printinghub-backend'     # change if you want a different Cloud Run service name
  _REGION: 'europe-west1'             # or 'europe-central2' (Warsaw) if you prefer
